# Расхождения между начальной инструкцией и текущей реализацией

## Ключевые изменения в структуре и логике проекта

### 1. Разделение инфраструктуры и приложения
**Изменение:** Проект разделен на две части:
- `infrastructure/` - общие ресурсы (PostgreSQL, Redis) с отдельным `docker-compose.yml`
- `BrashLens/` - основное приложение (backend, frontend) с отдельным `docker-compose.yml`

**Влияние на разработку:**
- Инфраструктура запускается отдельно: `cd infrastructure && docker compose up -d`
- Приложение использует внешнюю сеть `shared-network` (external: true)
- При деплое на сервер может использоваться существующая инфраструктура (shared_postgres, shared_redis)

### 2. Отдельный сервис chat-bot
**Изменение:** Telegram бот вынесен в отдельный Docker сервис с собственным `Dockerfile.bot`

**Влияние на разработку:**
- Бот не встроен в backend, работает независимо
- Имеет собственный контейнер `brashlens_chat_bot`
- Использует тот же код из `backend/app/bot/`, но запускается отдельно
- Для webhook режима: порт 8443 (expose, не публикуется наружу)

### 3. API версионирование
**Изменение:** Все API endpoints используют версионирование `/api/v1/`

**Влияние на разработку:**
- Все новые endpoints должны быть в `app/api/v1/`
- Роутеры организованы по функциональности: `health.py`, `cache.py`, `tasks.py`, `test.py`, `webhook.py`
- При добавлении новых версий API создавать `app/api/v2/`

### 4. Файл .secret как справочник
**Изменение:** Файл `.secret` используется как справочник секретов, не для прямого использования

**Влияние на разработку:**
- `.secret` НЕ коммитится в Git
- Используется для заполнения `.env` файлов вручную
- Содержит актуальные учетные данные для БД (пользователь: `govardvolov`)
- Для разных окружений (dev/prod) используются разные `.env` файлы

### 5. Скрипт инициализации БД
**Изменение:** Добавлен `infrastructure/init_db.sh` для автоматической инициализации БД

**Влияние на разработку:**
- После первого запуска инфраструктуры: `cd infrastructure && ./init_db.sh`
- Скрипт создает БД `brashlens_db` и пользователя `govardvolov`
- Удаляет лишних пользователей, настраивает права доступа
- Используется при настройке нового окружения

### 6. Автоматический деплой уже настроен
**Изменение:** Автоматический деплой через GitHub webhook уже реализован

**Влияние на разработку:**
- НЕ нужно настраивать деплой заново при дальнейшей разработке
- При пуше в `main` автоматически запускается деплой на сервер
- Скрипт `deploy.sh` уже существует и работает
- При добавлении новых зависимостей или миграций - они применятся автоматически

### 7. Структура Docker Network
**Изменение:** Используется единая сеть `shared-network` для всех сервисов

**Влияние на разработку:**
- Инфраструктура создает сеть: `shared-network` (driver: bridge)
- Приложение подключается к существующей сети: `external: true`
- Все сервисы обращаются друг к другу по именам контейнеров:
  - `brashlens_postgres:5432`
  - `brashlens_redis:6379`
- При добавлении новых сервисов использовать ту же сеть

### 8. Разделение .env файлов
**Изменение:** Множественные `.env` файлы:
- `infrastructure/.env` - для PostgreSQL и Redis
- `BrashLens/.env` - для переменных приложения
- `BrashLens/backend/.env` - для секретов backend (SECRET_KEY, токены)

**Влияние на разработку:**
- При настройке окружения нужно заполнить все три `.env` файла
- Использовать данные из `.secret` как справочник
- Для продакшна использовать production значения токенов

### 9. Celery Beat с фиксированным schedule файлом
**Изменение:** Celery Beat использует `--schedule=/tmp/celerybeat-schedule` для работы на сервере

**Влияние на разработку:**
- Параметр обязателен для работы на сервере (права доступа)
- При добавлении периодических задач они автоматически сохраняются в `/tmp/celerybeat-schedule`

### 10. Health checks для всех сервисов
**Изменение:** Все сервисы имеют health checks

**Влияние на разработку:**
- Backend: HTTP GET `/api/v1/health` внутри контейнера
- PostgreSQL: `pg_isready`
- Redis: `redis-cli ping`
- При добавлении новых сервисов добавлять health checks

## Что НЕ изменилось (стандартные практики)

- Git workflow: работа в `dev`, мерж в `main`
- Структура кода: models, schemas, services, api
- Использование Alembic для миграций
- Async SQLAlchemy 2.0
- Pydantic v2 для валидации
- Type hints везде
- Rate limiting и CORS настроены

## Рекомендации для дальнейшей разработки

1. **При добавлении новых сервисов:**
   - Использовать `shared-network` (external: true)
   - Добавить health check
   - Использовать данные из `.secret` для конфигурации

2. **При работе с БД:**
   - Всегда использовать миграции Alembic
   - После создания миграции: `docker compose exec backend alembic upgrade head`
   - Пользователь БД: `govardvolov`, БД: `brashlens_db`

3. **При деплое:**
   - Автоматический деплой уже работает, просто пушить в `main`
   - При необходимости обновить `deploy.sh` на сервере

4. **При работе с секретами:**
   - Использовать `.secret` как справочник
   - НЕ коммитить реальные значения в Git
   - Для dev и prod использовать разные токены/ключи
